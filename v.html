<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Molecular Dynamics | NH3BH3 Simulation</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #050505;
            --accent: #00f2ff;
            --danger: #ff0055;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0; background: var(--bg); color: white;
            font-family: 'Space Grotesk', sans-serif; overflow: hidden;
        }

        /* HUD Overlay */
        .hud {
            position: absolute; padding: 25px; pointer-events: none; width: 100%;
            box-sizing: border-box; display: flex; justify-content: space-between; z-index: 10;
        }

        .panel {
            background: var(--glass); backdrop-filter: blur(10px);
            border: 1px solid var(--border); border-radius: 4px; padding: 20px;
            pointer-events: auto;
        }

        .title-block h1 {
            margin: 0; font-size: 1.2rem; letter-spacing: 4px; text-transform: uppercase;
            background: linear-gradient(90deg, #fff, var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .status-tag {
            font-size: 0.7rem; color: var(--accent); border: 1px solid var(--accent);
            padding: 2px 8px; border-radius: 10px; margin-top: 5px; display: inline-block;
        }

        /* Controls */
        .controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 100; }
        
        button {
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            padding: 12px 30px; border-radius: 2px; cursor: pointer; font-family: 'Space Grotesk';
            font-weight: bold; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase; letter-spacing: 2px;
        }

        button:hover { background: var(--accent); color: black; box-shadow: 0 0 30px var(--accent); }

        /* Data Visualization */
        .data-viz { width: 300px; }
        .chart-container { height: 150px; margin-top: 15px; }

        #reaction-progress {
            width: 100%; height: 2px; background: #222; margin-top: 15px; position: relative;
        }
        #progress-bar { width: 0%; height: 100%; background: var(--accent); transition: width 0.1s; }

        /* Transition Alert */
        #transition-alert {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--danger); font-size: 2rem; font-weight: 900; letter-spacing: 10px;
            display: none; text-shadow: 0 0 20px var(--danger); z-index: 5;
        }

        /* Legend */
        .legend { font-size: 0.8rem; margin-top: 20px; }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .circle { width: 10px; height: 10px; border-radius: 50%; }
    </style>
</head>
<body>

<div class="hud">
    <div class="panel">
        <div class="title-block">
            <h1>Molecular Dynamics v2.0</h1>
            <div class="status-tag">REAL-TIME QUANTUM KINETICS</div>
        </div>
        
        <div class="legend">
            <div class="legend-item"><div class="circle" style="background:#4444ff"></div> Nitrogen (Nucleus + Shell)</div>
            <div class="legend-item"><div class="circle" style="background:#ff44aa"></div> Boron (Nucleus + Shell)</div>
            <div class="legend-item"><div class="circle" style="background:#ffffff"></div> Hydrogen (1s Orbital)</div>
        </div>

        <div id="reaction-progress"><div id="progress-bar"></div></div>
        <div style="font-size: 0.6rem; color: #666; margin-top: 5px;">REACTION COORDINATE MAP</div>
    </div>

    <div class="panel data-viz">
        <h2 style="font-size: 0.8rem; margin: 0; color: #888;">POTENTIAL ENERGY SURFACE</h2>
        <div class="chart-container">
            <canvas id="pesChart"></canvas>
        </div>
        <div id="energy-readout" style="font-family: monospace; color: var(--accent); font-size: 1.2rem; margin-top: 10px;">
            E: -82.4150 Ha
        </div>
    </div>
</div>

<div id="transition-alert">TRANSITION STATE</div>

<div class="controls">
    <button onclick="runMechanism()">Trigger Dehydrogenation</button>
</div>

<!-- Custom Shaders -->
<script id="fresnel-vertex" type="x-shader/x-vertex">
    varying vec3 vNormal;
    varying vec3 vPositionNormal;
    void main() {
        vNormal = normalize(normalMatrix * normal);
        vPositionNormal = normalize((modelViewMatrix * vec4(position, 1.0)).xyz);
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
</script>

<script id="fresnel-fragment" type="x-shader/x-fragment">
    varying vec3 vNormal;
    varying vec3 vPositionNormal;
    uniform vec3 glowColor;
    void main() {
        float intensity = pow(0.7 - dot(vNormal, vPositionNormal), 4.0);
        gl_FragColor = vec4(glowColor, intensity);
    }
</script>

<script>
    /** SCENE ENGINE **/
    let scene, camera, renderer, clock;
    let molecule = new THREE.Group();
    let nAtom, bAtom, hAtoms = [];
    let pesChart;
    let isReacting = false;

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        clock = new THREE.Clock();

        // Lighting
        const p1 = new THREE.PointLight(0x00f2ff, 1, 50);
        p1.position.set(5, 5, 5);
        scene.add(p1);
        scene.add(new THREE.AmbientLight(0xffffff, 0.2));

        scene.add(molecule);
        createNH3BH3();
        initChart();
        
        camera.position.set(0, 1, 7);
        animate();
    }

    function createAtom(color, size, x, y, z) {
        const group = new THREE.Group();
        
        // Nucleus
        const nucGeo = new THREE.SphereGeometry(size * 0.4, 32, 32);
        const nucMat = new THREE.MeshPhongMaterial({ color: color, shininess: 100 });
        const nucleus = new THREE.Mesh(nucGeo, nucMat);
        
        // Fresnel Electron Cloud
        const cloudGeo = new THREE.SphereGeometry(size, 32, 32);
        const cloudMat = new THREE.ShaderMaterial({
            uniforms: { glowColor: { value: new THREE.Color(color) } },
            vertexShader: document.getElementById('fresnel-vertex').textContent,
            fragmentShader: document.getElementById('fresnel-fragment').textContent,
            transparent: true,
            side: THREE.BackSide
        });
        const cloud = new THREE.Mesh(cloudGeo, cloudMat);

        group.add(nucleus);
        group.add(cloud);
        group.position.set(x, y, z);
        molecule.add(group);
        return group;
    }

    function createNH3BH3() {
        nAtom = createAtom(0x4444ff, 0.6, -0.8, 0, 0); // Nitrogen
        bAtom = createAtom(0xff44aa, 0.6, 0.8, 0, 0);  // Boron

        const hPos = [
            [-1.4, 0.7, 0.4], [-1.4, -0.7, 0.4], [-1.2, 0, -0.8], // N-H
            [1.4, 0.7, -0.4], [1.4, -0.7, -0.4], [1.2, 0, 0.8]   // B-H
        ];

        hPos.forEach((p, i) => {
            const h = createAtom(0xffffff, 0.25, p[0], p[1], p[2]);
            hAtoms.push({ 
                mesh: h, 
                origPos: new THREE.Vector3(p[0], p[1], p[2]),
                reactive: (i === 2 || i === 5) 
            });
        });
    }

    /** MECHANISM LOGIC **/
    async function runMechanism() {
        if(isReacting) return;
        isReacting = true;
        
        const hN = hAtoms[2].mesh;
        const hB = hAtoms[5].mesh;
        const alert = document.getElementById('transition-alert');
        const prog = document.getElementById('progress-bar');
        const energyText = document.getElementById('energy-readout');

        // Stage 1: Activation
        gsap.to(prog, { width: '40%', duration: 2 });
        gsap.to([hN.position, hB.position], { 
            x: 0, y: 1.2, z: 0, 
            duration: 2, 
            ease: "power2.inOut",
            onUpdate: () => {
                const e = -82.4150 + (Math.random() * 0.5);
                energyText.innerText = `E: ${e.toFixed(4)} Ha`;
                updateChart(e);
            }
        });

        await delay(2000);

        // Stage 2: Transition State
        alert.style.display = 'block';
        gsap.to(hN.scale, { x: 1.5, y: 1.5, z: 1.5, duration: 0.2, yoyo: true, repeat: 5 });
        gsap.to(hB.scale, { x: 1.5, y: 1.5, z: 1.5, duration: 0.2, yoyo: true, repeat: 5 });
        
        await delay(1200);
        alert.style.display = 'none';

        // Stage 3: H2 Release
        gsap.to(prog, { width: '100%', duration: 1.5 });
        const h2Group = new THREE.Group();
        scene.add(h2Group);
        h2Group.add(hN, hB);

        gsap.to(h2Group.position, { y: 15, x: 10, duration: 3, ease: "power2.in" });
        gsap.to(nAtom.position, { x: -0.6, duration: 1 }); // N-B bond shortens (Double bond char)
        gsap.to(bAtom.position, { x: 0.6, duration: 1 });

        // Final Stabilization
        energyText.innerText = "E: -82.6842 Ha";
        energyText.style.color = "#4ade80";
        isReacting = false;
    }

    /** ANIMATION LOOP **/
    function animate() {
        requestAnimationFrame(animate);
        const t = clock.getElapsedTime();

        // Subtle Brownian Motion / Vibration
        if(!isReacting) {
            molecule.rotation.y += 0.005;
            hAtoms.forEach((h, i) => {
                h.mesh.position.y = h.origPos.y + Math.sin(t * 10 + i) * 0.02;
            });
        }

        renderer.render(scene, camera);
    }

    /** CHARTING **/
    function initChart() {
        const ctx = document.getElementById('pesChart').getContext('2d');
        pesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [{
                    data: Array(20).fill(-82.415),
                    borderColor: '#00f2ff',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0,
                    fill: true,
                    backgroundColor: 'rgba(0, 242, 255, 0.05)'
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    x: { display: false }, 
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { display: false } } 
                }
            }
        });
    }

    function updateChart(val) {
        pesChart.data.datasets[0].data.push(val);
        pesChart.data.datasets[0].data.shift();
        pesChart.update('none');
    }

    function delay(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    window.onload = init;
</script>
</body>
</html>