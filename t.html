<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quantum FLP Virtual Lab | Auto Reaction Video</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@300;500&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#020408; --panel:rgba(13,17,23,0.92);
      --accent:#58a6ff; --catalyst:#bc8cff;
      --success:#3fb950; --danger:#f85149; --border:#30363d;
    }
    body{margin:0;background:var(--bg);color:#c9d1d9;font-family:'JetBrains Mono',monospace;overflow:hidden;height:100vh;}
    #canvas-container{position:absolute;inset:0;z-index:1;}
    .hud{
      position:relative;z-index:10;pointer-events:none;
      display:grid;grid-template-columns:360px 1fr 360px;
      height:100%;padding:18px;gap:18px;box-sizing:border-box;
    }
    .panel{
      background:var(--panel);border:1px solid var(--border);border-radius:14px;
      padding:18px;backdrop-filter:blur(14px);pointer-events:auto;
      display:flex;flex-direction:column;gap:14px;
      box-shadow:0 10px 40px rgba(0,0,0,0.75);
    }
    h1,h3{font-family:'Orbitron',sans-serif;margin:0;letter-spacing:2px;}
    h3{color:var(--accent);}
    .label-sm{font-size:0.65rem;color:#8b949e;text-transform:uppercase;}

    .vqe-window{
      background:#000;border:1px solid #1f6feb;height:140px;border-radius:6px;position:relative;overflow:hidden;
    }
    .vqe-status{
      position:absolute;top:6px;left:8px;font-size:0.6rem;color:var(--accent);z-index:5;
      padding:3px 6px;border:1px solid rgba(88,166,255,0.3);border-radius:6px;background:rgba(0,0,0,0.35);
    }
    #vqeChart{width:100%!important;height:100%!important;}
    #pathChart{width:100%!important;height:160px!important;}

    .center-hud{
      grid-column:2;display:flex;flex-direction:column;justify-content:flex-end;align-items:center;
      padding-bottom:26px;gap:12px;
    }

    .btn-group{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;pointer-events:auto;}
    button{
      background:#21262d;border:1px solid var(--border);color:white;
      padding:12px 16px;border-radius:10px;cursor:pointer;
      font-family:'Orbitron';font-size:0.72rem;transition:0.25s;letter-spacing:0.5px;
    }
    button:hover:not(:disabled){border-color:var(--accent);background:#30363d;box-shadow:0 0 18px rgba(88,166,255,0.5);transform:translateY(-1px);}
    button:disabled{opacity:0.3;cursor:not-allowed;}

    .metric-card{
      background:rgba(0,0,0,0.25);border:1px solid rgba(48,54,61,0.7);
      border-left:4px solid var(--accent);padding:12px;border-radius:10px;
    }
    .val{font-size:1.15rem;font-family:'Orbitron';color:var(--success);margin-top:4px;}

    #reaction-log{
      flex-grow:1;font-size:0.72rem;overflow-y:auto;color:#8b949e;border-top:1px solid var(--border);padding-top:10px;
    }
    .log-entry{margin-bottom:8px;border-left:2px solid var(--accent);padding-left:10px;animation:fadeIn 0.25s ease;}
    @keyframes fadeIn{from{opacity:0;transform:translateX(-5px);}to{opacity:1;transform:translateX(0);}}

    #ts-alert{
      position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);
      font-family:'Orbitron';color:var(--danger);font-size:2rem;display:none;z-index:100;
      text-shadow:0 0 25px rgba(248,81,73,0.9);pointer-events:none;
    }

    .timeline{
      width:680px;max-width:92vw;height:12px;border-radius:999px;background:rgba(255,255,255,0.10);
      overflow:hidden;border:1px solid rgba(255,255,255,0.12);
      pointer-events:auto;
    }
    .timeline>div{
      height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--catalyst));
      transition:width 0.25s linear;
    }
    .caption{pointer-events:none;margin-top:10px;font-size:0.82rem;color:#c9d1d9;opacity:0.92;text-align:center;max-width:820px;}
  </style>
</head>

<body>
<div id="canvas-container"></div>
<div id="ts-alert">TRANSITION STATE</div>

<div class="hud">

  <!-- LEFT -->
  <div class="panel">
    <div class="label-sm">Quantum Solver</div>
    <h3>VQE CONVERGENCE</h3>

    <div class="vqe-window">
      <div class="vqe-status" id="vqe-msg">AUTO MODE READY</div>
      <canvas id="vqeChart"></canvas>
    </div>

    <div class="metric-card">
      <div class="label-sm">Ground State (E_sys)</div>
      <div class="val" id="val-e">-- Ha</div>
    </div>

    <div class="metric-card" style="border-left-color:var(--catalyst);">
      <div class="label-sm">Binding ΔE</div>
      <div class="val" id="val-bind">-- kJ/mol</div>
      <div id="doe-status" style="font-size:0.72rem;margin-top:6px;color:#8b949e;">
        DOE Target: -15 to -40 kJ/mol
      </div>
    </div>

    <div class="metric-card">
      <div class="label-sm">Gibbs Free Energy (ΔG)</div>
      <div class="val" id="val-gibbs">-- kJ/mol</div>
      <div id="thermo-label" style="font-size:0.72rem;margin-top:6px;color:#8b949e;">Status: Ready</div>
    </div>
  </div>

  <!-- CENTER -->
  <div class="center-hud">
    <div style="text-align:center;">
      <h1 style="font-size:1.25rem;color:var(--accent);">FLP QUANTUM REACTOR</h1>
      <div style="color:var(--catalyst);font-size:0.72rem;letter-spacing:3px;margin-top:6px;">
        NH₃BH₃ DEHYDROGENATION • AUTO SIMULATION
      </div>
    </div>

    <div class="timeline"><div id="timelineBar"></div></div>
    <div class="caption" id="caption">Press ▶ Play to start the reaction movie.</div>

    <div class="btn-group">
      <button id="playBtn" onclick="playMovie()">▶ Play</button>
      <button id="pauseBtn" onclick="pauseMovie()" disabled>⏸ Pause</button>
      <button id="restartBtn" onclick="restartMovie()">⟲ Restart</button>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="panel">
    <div class="label-sm">Reaction Coordinate</div>
    <h3>PATHWAY LOG</h3>

    <div id="reaction-log">
      <div class="log-entry">System online. Auto movie mode ready.</div>
    </div>

    <div style="height:160px;">
      <canvas id="pathChart"></canvas>
    </div>

    <div class="metric-card" style="border-left-color:#fff;">
      <div class="label-sm">Hydrogen Yield</div>
      <div style="display:flex;gap:10px;align-items:center;margin-top:10px;">
        <div id="y1" style="width:12px;height:12px;border-radius:3px;border:1px solid #fff;"></div>
        <div id="y2" style="width:12px;height:12px;border-radius:3px;border:1px solid #fff;"></div>
        <div id="y3" style="width:12px;height:12px;border-radius:3px;border:1px solid #fff;"></div>
        <span id="yield-txt" style="font-size:0.78rem;margin-left:auto;">0/3 H₂</span>
      </div>
    </div>
  </div>

</div>

<script>
/* ------------------ DATA ------------------ */
const STEPS = [
  { title:"Catalyst Binding", e:-82.1980, bind:-34.12, gibbs:-12.5,
    caption:"Step 1/4: FLP catalyst binds to NH₃BH₃ → activation complex formation.",
    log:"Catalyst bound to AB. Dative interaction created.", ts:false },
  { title:"H₂ Release #1", e:-81.9540, bind:-10.50, gibbs:-5.2,
    caption:"Step 2/4: First H₂ release → NH₃BH₃ → NH₂BH₂ + H₂.",
    log:"1st H₂ released. Intermediate NH₂BH₂ forms.", ts:true },
  { title:"H₂ Release #2", e:-81.6210, bind:+4.20, gibbs:-18.4,
    caption:"Step 3/4: Second H₂ release → NH₂BH₂ → NHBH + H₂.",
    log:"2nd H₂ released. N–B bond rearrangement detected.", ts:true },
  { title:"H₂ Release #3", e:-81.1050, bind:+12.80, gibbs:-32.1,
    caption:"Step 4/4: Final H₂ release → NHBH → NBH + H₂.",
    log:"Final H₂ released. Product NBH stabilized.", ts:true }
];

/* ------------------ FIXED H2 PAIRING ------------------
   Release hydrogen in deterministic realistic pairs:
   Release #1 -> H0 + H3
   Release #2 -> H1 + H4
   Release #3 -> H2 + H5
------------------------------------------------------ */
const H2_PAIRS = [
  [0, 3],
  [1, 4],
  [2, 5],
];

/* ------------------ THREE.JS ------------------ */
let scene, camera, renderer, molecule, catalyst;
let atoms = { n:null, b:null, h:[] };
let h2ReleasedCount = 0;

function init3D(){
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true, preserveDrawingBuffer:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.getElementById("canvas-container").appendChild(renderer.domElement);

  const p1 = new THREE.PointLight(0x58a6ff, 1.2, 100);
  p1.position.set(5,5,7);
  scene.add(p1);
  scene.add(new THREE.AmbientLight(0xffffff, 0.22));

  molecule = new THREE.Group();
  atoms.n = atom(0x58a6ff, 0.5, -0.7,0,0);
  atoms.b = atom(0xbc8cff, 0.5, 0.7,0,0);
  molecule.add(atoms.n, atoms.b);

  const hPos=[
    [-1.25, 0.70, 0.35], [-1.25,-0.70, 0.35], [-1.25, 0, -0.85],
    [ 1.25, 0.70,-0.35], [ 1.25,-0.70,-0.35], [ 1.25, 0,  0.85]
  ];
  atoms.h=[];
  hPos.forEach(p=>{
    const H = atom(0xffffff,0.22,p[0],p[1],p[2]);
    atoms.h.push(H); molecule.add(H);
  });
  scene.add(molecule);

  const cageGeo = new THREE.IcosahedronGeometry(3.5,1);
  const cageMat = new THREE.MeshBasicMaterial({ color:0xbc8cff, wireframe:true, transparent:true, opacity:0.08 });
  catalyst = new THREE.Mesh(cageGeo, cageMat);
  scene.add(catalyst);

  camera.position.set(0,3,10);
  camera.lookAt(0,0,0);
  animate();
}

function atom(color, size, x,y,z){
  const mesh = new THREE.Mesh(
    new THREE.SphereGeometry(size,32,32),
    new THREE.MeshPhongMaterial({ color, shininess:110 })
  );
  mesh.position.set(x,y,z);
  return mesh;
}

function animate(){
  requestAnimationFrame(animate);
  molecule.rotation.y += 0.005;
  catalyst.rotation.y -= 0.002;
  renderer.render(scene,camera);
}

window.addEventListener("resize", ()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

/* ------------------ CHARTS ------------------ */
let vqeChart, pathChart;

function initCharts(){
  vqeChart = new Chart(document.getElementById("vqeChart"),{
    type:"line",
    data:{ labels:Array(30).fill(""), datasets:[{
      data:[], borderColor:"#58a6ff", borderWidth:2, pointRadius:0, tension:0.35
    }]},
    options:{ responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}
    }
  });

  pathChart = new Chart(document.getElementById("pathChart"),{
    type:"line",
    data:{ labels:["Start","Bind","H₂-1","H₂-2","H₂-3"],
      datasets:[{ data:[0,null,null,null,null], borderColor:"#bc8cff",
        backgroundColor:"rgba(188,140,255,0.12)", fill:true, pointRadius:4, tension:0.25 }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{ ticks:{ color:"#8b949e", font:{size:10}}, grid:{color:"#30363d"}},
        y:{ ticks:{ color:"#8b949e", font:{size:10}}, grid:{color:"#30363d"}}
      }
    }
  });
}

/* ------------------ AUTO MOVIE ENGINE ------------------ */
let currentStep = 0;
let playing = false;
let paused = false;

function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }
function setButtons(){
  document.getElementById("playBtn").disabled = playing;
  document.getElementById("pauseBtn").disabled = !playing;
}
function playMovie(){
  if(playing) return;
  playing = true; paused = false; setButtons();
  movieLoop();
}
function pauseMovie(){
  paused = true; playing = false; setButtons();
  document.getElementById("vqe-msg").innerText = "PAUSED";
}
function restartMovie(){
  paused=false; playing=false; currentStep=0; h2ReleasedCount=0;
  resetUI(); setButtons();
  document.getElementById("caption").innerText = "Press ▶ Play to start the reaction movie.";
}

async function movieLoop(){
  document.getElementById("vqe-msg").innerText = "AUTO MODE RUNNING...";
  while(currentStep < STEPS.length){
    if(paused) return;

    await runStep(currentStep);
    currentStep++;

    const progress = Math.round((currentStep / STEPS.length) * 100);
    document.getElementById("timelineBar").style.width = progress + "%";
    await sleep(800);
  }
  playing=false; setButtons();
  document.getElementById("vqe-msg").innerText = "MOVIE COMPLETE ✅";
  document.getElementById("caption").innerText = "Simulation complete. 3 H₂ released.";
}

async function runStep(stepIndex){
  const step = STEPS[stepIndex];
  document.getElementById("caption").innerText = step.caption;

  // VQE chart
  await simulateVQE(step.e);

  // UI update
  updateUI(stepIndex, step);

  // 3D animation
  await animateChem(stepIndex);
}

async function simulateVQE(targetEnergy){
  const msg = document.getElementById("vqe-msg");
  msg.innerText = "VQE OPTIMIZATION...";
  for(let i=0;i<25;i++){
    if(paused) return;
    const val = targetEnergy + (Math.random()*0.4) + (0.35 - i*0.02);
    vqeChart.data.datasets[0].data.push(val);
    if(vqeChart.data.datasets[0].data.length > 30) vqeChart.data.datasets[0].data.shift();
    vqeChart.update();
    await sleep(55);
  }
  msg.innerText = "CONVERGED ✅";
}

function updateUI(stepIndex, step){
  document.getElementById("val-e").innerText = step.e.toFixed(4) + " Ha";
  document.getElementById("val-bind").innerText = (step.bind>0?"+":"") + step.bind.toFixed(2) + " kJ/mol";
  document.getElementById("val-gibbs").innerText = (step.gibbs>0?"+":"") + step.gibbs.toFixed(1) + " kJ/mol";

  // log
  const log = document.getElementById("reaction-log");
  log.innerHTML = `<div class="log-entry">▶ ${step.title}: ${step.log}</div>` + log.innerHTML;

  // path chart
  pathChart.data.datasets[0].data[stepIndex+1] = step.gibbs;
  pathChart.update();

  // DOE
  if(stepIndex===0){
    const doe = document.getElementById("doe-status");
    const ok = (step.bind<=-15 && step.bind>=-40);
    doe.innerText = ok ? "DOE TARGET MET ✅ (-15 to -40 kJ/mol)" : "OUTSIDE DOE RANGE ⚠️ (-15 to -40 kJ/mol)";
    doe.style.color = ok ? "var(--success)" : "var(--danger)";
  }

  // thermo
  const thermo=document.getElementById("thermo-label");
  if(step.gibbs<0){ thermo.innerText="Status: Spontaneous ✅ (ΔG < 0)"; thermo.style.color="var(--success)"; }
  else { thermo.innerText="Status: Non-spontaneous ⚠️"; thermo.style.color="var(--danger)"; }

  // yield
  if(stepIndex>=1){
    h2ReleasedCount++;
    const box=document.getElementById("y"+h2ReleasedCount);
    if(box) box.style.background="var(--success)";
    document.getElementById("yield-txt").innerText=`${h2ReleasedCount}/3 H₂`;
  }
}

async function animateChem(stepIndex){
  const alert=document.getElementById("ts-alert");

  if(stepIndex===0){
    gsap.to(catalyst.scale, { x:0.85, y:0.85, z:0.85, duration:1.1 });
    gsap.to(catalyst.material, { opacity:0.35, duration:1.1 });
    await sleep(1200);
    return;
  }

  // transition state
  alert.style.display="block";
  gsap.fromTo(alert,{opacity:0},{opacity:1,duration:0.2,yoyo:true,repeat:4});
  await sleep(900);

  const pairIndex = stepIndex - 1;
  const [a,b] = H2_PAIRS[pairIndex];
  const h1 = atoms.h[a];
  const h2 = atoms.h[b];

  const h2Group=new THREE.Group();
  scene.add(h2Group);
  h2Group.add(h1); h2Group.add(h2);

  gsap.to(h2Group.position,{y:15,x:10,duration:2.1,ease:"power2.in"});
  gsap.to(atoms.n.position,{x:atoms.n.position.x+0.08,duration:1.2});
  gsap.to(atoms.b.position,{x:atoms.b.position.x-0.08,duration:1.2});

  await sleep(2200);
  alert.style.display="none";
}

/* ------------------ RESET ------------------ */
function resetUI(){
  document.getElementById("timelineBar").style.width="0%";
  document.getElementById("vqe-msg").innerText="AUTO MODE READY";
  document.getElementById("val-e").innerText="-- Ha";
  document.getElementById("val-bind").innerText="-- kJ/mol";
  document.getElementById("val-gibbs").innerText="-- kJ/mol";
  document.getElementById("thermo-label").innerText="Status: Ready";
  document.getElementById("thermo-label").style.color="#8b949e";
  document.getElementById("doe-status").innerText="DOE Target: -15 to -40 kJ/mol";
  document.getElementById("doe-status").style.color="#8b949e";
  document.getElementById("reaction-log").innerHTML=`<div class="log-entry">System reset. Press ▶ Play.</div>`;
  document.getElementById("yield-txt").innerText="0/3 H₂";
  document.getElementById("y1").style.background="";
  document.getElementById("y2").style.background="";
  document.getElementById("y3").style.background="";

  vqeChart.data.datasets[0].data=[]; vqeChart.update();
  pathChart.data.datasets[0].data=[0,null,null,null,null]; pathChart.update();

  catalyst.scale.set(1,1,1);
  catalyst.material.opacity=0.08;
}

window.onload=()=>{ init3D(); initCharts(); };
</script>
</body>
</html>
